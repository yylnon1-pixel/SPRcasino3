<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Crash - Multiplayer Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #0f0f14);
            --sec-bg: var(--tg-theme-secondary-bg-color, #1b1f3a);
            --text: var(--tg-theme-text-color, #ffffff);
            --btn: var(--tg-theme-button-color, #5e8fff);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #708499);
            --accent: var(--tg-theme-accent-text-color, #5e8fff);
            --success: #2ecc71;
            --danger: #ff4d4d;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0; background-color: var(--bg); color: var(--text);
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            position: relative; opacity: 0; transition: opacity 0.3s;
        }

        .grid-wrapper {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 45px 45px;
            z-index: 0; pointer-events: none;
        }

        .balance-card {
            position: relative; z-index: 2;
            background: linear-gradient(145deg, var(--sec-bg), rgba(255,255,255,0.05));
            padding: 12px 35px; border-radius: 20px;
            margin-top: 20px; font-size: 22px; font-weight: 900;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 8px;
        }

        .game-header {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative; z-index: 2;
        }

        #multiplier { 
            font-size: 72px; font-weight: 900; z-index: 10; margin: 10px 0; 
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        @keyframes multiplier-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .gold-text {
            color: #ffd700 !important;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            animation: multiplier-pulse 0.6s infinite ease-in-out;
        }

        #timer-display { 
            color: var(--btn); font-weight: 900; font-size: 14px; 
            text-transform: uppercase; letter-spacing: 1px;
        }

        .bets-list {
            position: relative; height: 180px; background: rgba(0,0,0,0.25);
            overflow-y: auto; border-top: 1px solid rgba(255,255,255,0.05); z-index: 10;
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
        }

        .bet-row {
            display: flex; justify-content: space-between; padding: 12px 20px;
            font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: 0.3s;
        }

        .bet-row.my-bet { background: rgba(94, 143, 255, 0.1); border-left: 4px solid var(--btn); }
        .bet-row.win { color: var(--success); font-weight: bold; background: rgba(46, 204, 113, 0.05); }
        .bet-row.loss { color: var(--danger); opacity: 0.6; }

        .panel {
            background: var(--sec-bg); padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            border-radius: 30px 30px 0 0; display: flex; flex-direction: column; gap: 12px;
            z-index: 11; box-shadow: 0 -10px 30px rgba(0,0,0,0.4);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .main-btn {
            padding: 20px; border-radius: 18px; border: none;
            background: var(--btn); color: var(--btn-text); font-weight: 900;
            text-transform: uppercase; font-size: 16px; cursor: pointer;
            transition: 0.1s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .main-btn:active { transform: scale(0.97); filter: brightness(0.9); }
        .main-btn.cashout { background: var(--success); color: #fff; }

        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-label { font-size: 11px; color: var(--hint); font-weight: 900; margin-left: 5px; text-transform: uppercase; }

        input {
            background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: #fff;
            padding: 16px; border-radius: 14px; font-size: 18px; outline: none; font-weight: bold;
        }
        input:focus { border-color: var(--btn); }

        #rocket {
            position: absolute; font-size: 55px; bottom: 25%; left: 10%;
            transition: transform 0.2s linear; display: none; z-index: 5;
            filter: drop-shadow(0 0 15px rgba(255,255,255,0.3));
        }
    </style>
</head>
<body>
    <div class="grid-wrapper"></div>

    <div class="game-header">
        <div class="balance-card">
            <span id="bal-val">0.00</span> üí∞
        </div>
        <div id="timer-display">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="multiplier">1.00x</div>
        <div id="rocket">üöÄ</div>
    </div>

    <div class="bets-list" id="betsCont"></div>

    <div class="panel">
        <div class="input-group">
            <span class="input-label">–†–∞–∑–º–µ—Ä —Å—Ç–∞–≤–∫–∏</span>
            <input type="number" id="betInp" value="10" step="1" inputmode="decimal">
        </div>
        <button id="actionBtn" class="main-btn" onclick="handleBtn()">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const NGROK_URL = 'https://petrificant-phung-elliptically.ngrok-free.dev'; 
        const socket = io(NGROK_URL, { 
            transports: ['websocket', 'polling'],
            auth: { tgId: tg.initDataUnsafe?.user?.id || 12345 } 
        });
        
        const user = tg.initDataUnsafe?.user;
        const userId = user ? user.id : 12345;
        const userName = user ? (user.username || user.first_name) : "–ò–≥—Ä–æ–∫";

        let balance = 0;
        let myCurrentBet = null;
        let isProcessing = false;
        let botTimeouts = [];

        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            if (!myCurrentBet || myCurrentBet.status !== 'playing') window.location.href = 'index.html';
        });

        function updateUI(newBalance) {
            if (newBalance !== undefined) balance = newBalance;
            document.getElementById('bal-val').textContent = (Number.isInteger(balance) ? balance : balance.toFixed(2));
        }

        async function fetchBalance() {
            try {
                const res = await fetch(`${NGROK_URL}/get-balance/${userId}`, { 
                    headers: { 'ngrok-skip-browser-warning': 'true' } 
                });
                const data = await res.json();
                updateUI(data.balance);
            } catch (e) { console.error("Balance fetch error"); }
        }

        function updateBetsDisplay(activeBets, status) {
            const cont = document.getElementById('betsCont');
            if (status !== 'crashed') {
                const currentRows = cont.querySelectorAll('.bet-row');
                currentRows.forEach(row => {
                    const id = row.id.replace('bet-', '');
                    if (!activeBets.find(b => b.tgId == id)) row.remove();
                });
            }

            activeBets.forEach((bet, index) => {
                let row = document.getElementById(`bet-${bet.tgId}`);
                const isMe = bet.tgId == userId;

                if (!row) {
                    const delay = (status === 'waiting' && !isMe) ? (index * 400 + Math.random() * 200) : 0;
                    const t = setTimeout(() => {
                        const timerT = document.getElementById('timer-display').textContent;
                        if (!document.getElementById(`bet-${bet.tgId}`) && (timerT.includes('–í–∑–ª–µ—Ç') || status !== 'waiting')) {
                            const html = `<div class="bet-row ${isMe ? 'my-bet' : ''}" id="bet-${bet.tgId}">
                                <span>${isMe ? '‚≠êÔ∏è' : 'üë§'} ${bet.name}</span>
                                <span class="bet-info">${bet.amount.toFixed(2)} üí∞</span>
                            </div>`;
                            cont.insertAdjacentHTML('afterbegin', html);
                        }
                    }, delay);
                    botTimeouts.push(t);
                } else {
                    const info = row.querySelector('.bet-info');
                    if (bet.status === 'won' && !row.classList.contains('win')) {
                        row.classList.add('win');
                        info.textContent = `x${bet.winMult} ${bet.amount.toFixed(2)} üí∞`;
                    } else if (status === 'crashed' && bet.status !== 'won') {
                        row.classList.add('loss');
                    }
                }
            });
        }

        socket.on('crashUpdate', (data) => {
            const { crashState, activeBets } = data;
            const multEl = document.getElementById('multiplier');
            const btn = document.getElementById('actionBtn');
            const rocket = document.getElementById('rocket');
            const timer = document.getElementById('timer-display');

            if (crashState.status === 'flying' && crashState.multiplier >= 2.0) {
                multEl.classList.add('gold-text');
            } else {
                multEl.classList.remove('gold-text');
            }

            if (crashState.status === 'waiting') {
                if (multEl.textContent === "BOOM!" || multEl.style.color.includes('rgb')) {
                    document.getElementById('betsCont').innerHTML = '';
                    botTimeouts.forEach(clearTimeout);
                    botTimeouts = [];
                }
                isProcessing = false;
                multEl.textContent = "x1.00";
                multEl.style.color = 'var(--text)';
                timer.textContent = `–í–∑–ª–µ—Ç —á–µ—Ä–µ–∑ ${crashState.timer.toFixed(0)}—Å`;
                rocket.style.display = 'none';
                if (!myCurrentBet) {
                    btn.disabled = false;
                    btn.classList.remove('cashout');
                    btn.textContent = "–ü–æ—Å—Ç–∞–≤–∏—Ç—å";
                }
            } 
            else if (crashState.status === 'flying') {
                multEl.textContent = crashState.multiplier.toFixed(2) + "x";
                timer.textContent = "–í –ü–û–õ–ï–¢–ï";
                rocket.style.display = 'block';
                let moveX = Math.min((crashState.multiplier - 1) * 55, window.innerWidth - 75);
                let moveY = Math.min((crashState.multiplier - 1) * 32, window.innerHeight * 0.4);
                rocket.style.transform = `translate(${moveX}px, -${moveY}px) rotate(15deg)`;

                if (myCurrentBet && myCurrentBet.status === 'playing') {
                    btn.disabled = false;
                    btn.classList.add('cashout');
                    btn.textContent = "–ó–ê–ë–†–ê–¢–¨ " + (myCurrentBet.amount * crashState.multiplier).toFixed(2);
                } else if (!myCurrentBet) {
                    btn.disabled = true;
                    btn.textContent = "–ò–ì–†–ê –ò–î–ï–¢...";
                }
            } 
            else if (crashState.status === 'crashed') {
                multEl.textContent = "BOOM!";
                multEl.style.color = 'var(--danger)';
                timer.textContent = "–í–ó–†–´–í " + crashState.multiplier.toFixed(2) + "x";
                btn.disabled = true;
                btn.classList.remove('cashout');
                btn.textContent = "–ö–†–ê–®...";
                myCurrentBet = null;
                isProcessing = false;
            }
            updateBetsDisplay(activeBets, crashState.status);
        });

        socket.on('balanceUpdate', (data) => {
            if (Number(data.tgId) === Number(userId)) {
                updateUI(data.newBalance);
            }
        });

        socket.on('error', (data) => {
            tg.showAlert(data.message);
            isProcessing = false;
            myCurrentBet = null;
            document.getElementById('actionBtn').disabled = false;
            document.getElementById('actionBtn').textContent = "–ü–æ—Å—Ç–∞–≤–∏—Ç—å";
        });

        async function handleBtn() {
            if (isProcessing) return;
            const btn = document.getElementById('actionBtn');
            const amount = parseFloat(document.getElementById('betInp').value);

            if (myCurrentBet && myCurrentBet.status === 'playing') {
                isProcessing = true;
                socket.emit('crashCashout', { tgId: userId });
                btn.disabled = true;
                btn.textContent = "–í–ó–Ø–¢–û!";
                tg.HapticFeedback.notificationOccurred('success');
                return;
            }

            if (isNaN(amount) || amount <= 0 || amount > balance) {
                tg.showAlert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞ –∏–ª–∏ –º–∞–ª–æ —Å—Ä–µ–¥—Å—Ç–≤!");
                return;
            }

            isProcessing = true;
            // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
            const betData = { tgId: userId, name: userName, amount: amount };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞–≤–∫—É. –°–µ—Ä–≤–µ—Ä —Å–∞–º –ø—Ä–æ–≤–µ—Ä–∏—Ç –±–∞–ª–∞–Ω—Å –∏ —Å–ø–∏—à–µ—Ç –µ–≥–æ –≤ –ë–î
            socket.emit('placeCrashBet', betData);
            
            myCurrentBet = { ...betData, status: 'playing' };
            btn.disabled = true;
            btn.textContent = "–ü–†–ò–ù–Ø–¢–û";
            tg.HapticFeedback.impactOccurred('medium');
        }

        window.onload = () => {
            fetchBalance();
            tg.ready();
            tg.expand();
            document.body.style.opacity = '1';
        };
    </script>
</body>
</html>