<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wheel Pro - –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #0f0f14);
            --sec-bg: var(--tg-theme-secondary-bg-color, #1b1f3a);
            --text: var(--tg-theme-text-color, #ffffff);
            --btn: var(--tg-theme-button-color, #5e8fff);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --success: #2ecc71;
            --danger: #ff4757;
            --warning: #f8d448;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0; background-color: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            min-height: 100vh; padding: 20px; box-sizing: border-box;
            overflow: hidden; touch-action: manipulation; position: relative;
        }

        .grid-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 45px 45px; z-index: 0; pointer-events: none;
        }

        .balance-card {
            position: relative; z-index: 1;
            background: linear-gradient(145deg, var(--sec-bg), rgba(255,255,255,0.05));
            padding: 15px 45px; border-radius: 25px;
            font-size: 28px; font-weight: 900; margin-bottom: 30px; margin-top: 10px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.4), inset 0 0 10px rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 10px;
        }

        .wheel-box {
            position: relative; width: 80vw; max-width: 320px; aspect-ratio: 1 / 1;
            display: flex; align-items: center; justify-content: center; 
            margin: 20px 0 40px 0; z-index: 1;
        }

        .arrow {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 15px solid transparent;
            border-right: 15px solid transparent; border-top: 30px solid var(--text); 
            z-index: 100; filter: drop-shadow(0 4px 5px rgba(0,0,0,0.5));
        }

        #wheel {
            width: 100%; height: 100%; border-radius: 50%; position: absolute;
            transition: transform 8s cubic-bezier(0.1, 0, 0, 1);
            background: conic-gradient(
                var(--sec-bg) 0deg 45deg,
                var(--btn) 45deg 90deg,
                var(--sec-bg) 90deg 135deg,
                var(--success) 135deg 180deg,
                var(--sec-bg) 180deg 225deg,
                var(--warning) 225deg 270deg,
                var(--sec-bg) 270deg 315deg,
                var(--danger) 315deg 360deg
            );
            border: 8px solid var(--sec-bg); box-sizing: border-box;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.3);
        }

        .number-container {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: flex-start;
            padding-top: 25px; box-sizing: border-box; transform-origin: center center;
        }

        .number-container span { 
            font-size: 16px; font-weight: 900; 
            text-shadow: 0 1px 4px rgba(0,0,0,0.8); color: #ffffff;
        }

        .wheel-center {
            position: absolute; width: 60px; height: 60px; background: var(--sec-bg);
            border: 4px solid var(--text); border-radius: 50%; z-index: 50;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .spin-btn {
            position: relative; z-index: 1;
            width: 100%; max-width: 320px; padding: 20px; 
            font-size: 18px; font-weight: 900; border-radius: 20px; border: none; 
            background-color: var(--btn); color: var(--btn-text); 
            text-transform: uppercase; cursor: pointer;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3); transition: 0.1s;
        }

        .spin-btn:active { transform: scale(0.96); }
        .spin-btn:disabled { opacity: 0.5; filter: grayscale(0.5); }
    </style>
</head>
<body>
    <div class="grid-wrapper"></div>

    <div class="balance-card">
        <span id="balance">0.00</span> üí∞
    </div>

    <div class="wheel-box">
        <div class="arrow"></div>
        <div class="wheel-center">üíé</div>
        <div id="wheel">
            <div class="number-container" style="transform: rotate(22.5deg)"><span>0.05$</span></div>
            <div class="number-container" style="transform: rotate(67.5deg)"><span>2$</span></div>
            <div class="number-container" style="transform: rotate(112.5deg)"><span>0.05$</span></div>
            <div class="number-container" style="transform: rotate(157.5deg)"><span>5$</span></div>
            <div class="number-container" style="transform: rotate(202.5deg)"><span>0.05$</span></div>
            <div class="number-container" style="transform: rotate(247.5deg)"><span>25$</span></div>
            <div class="number-container" style="transform: rotate(292.5deg)"><span>0.05$</span></div>
            <div class="number-container" style="transform: rotate(337.5deg)"><span>10$</span></div>
        </div>
    </div>

    <button class="spin-btn" id="spinBtn" onclick="spin()">–ö—Ä—É—Ç–∏—Ç—å 1.00 USDT</button>

    <script>
        const tg = window.Telegram.WebApp;
        const NGROK_URL = 'https://petrificant-phung-elliptically.ngrok-free.dev'; 
        const userId = String(tg.initDataUnsafe?.user?.id || 12345);
        const backButton = tg.BackButton;

        let balance = 0;
        let currentRotation = 0; 

        tg.ready();
        tg.expand();
        backButton.show();
        backButton.onClick(() => { 
            if(!document.getElementById('spinBtn').disabled) window.location.href = 'index.html'; 
        });

        async function updateUI(forcedBalance = null) {
            if (forcedBalance !== null) {
                balance = Number(forcedBalance);
                document.getElementById('balance').textContent = balance.toFixed(2);
            } else {
                try {
                    const res = await fetch(`${NGROK_URL}/get-balance/${userId}?v=${Date.now()}`, {
                        headers: { 'ngrok-skip-browser-warning': 'true' }
                    });
                    const data = await res.json();
                    if (data.balance !== undefined) {
                        balance = Number(data.balance);
                        document.getElementById('balance').textContent = balance.toFixed(2);
                    }
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞");
                }
            }
        }

        async function spin() {
            await updateUI();
            if (balance < 1) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");

            const btn = document.getElementById('spinBtn');
            btn.disabled = true;
            backButton.hide(); 
            tg.enableClosingConfirmation();

            try {
                // 1. Play request
                const playRes = await fetch(`${NGROK_URL}/play-wheel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ tgId: userId, bet: 1.00 })
                });
                const playData = await playRes.json();
                
                if (!playRes.ok) throw new Error(playData.error || "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");

                // Update balance immediately (bet deducted)
                updateUI(playData.newBalance);
                tg.HapticFeedback.impactOccurred('heavy');

                const { angle, win, nearMiss } = playData;

                let visualOffset = nearMiss ? (Math.random() > 0.5 ? 0.5 : -0.5) : (Math.random() * 8 - 4); 
                const extraSpins = 3600; 
                const targetDegree = 360 - (angle % 360) + visualOffset;
                
                currentRotation = currentRotation + extraSpins + (targetDegree - (currentRotation % 360));
                
                const wheel = document.getElementById('wheel');
                wheel.style.transition = nearMiss 
                    ? 'transform 10s cubic-bezier(0.15, 0, 0.05, 1)' 
                    : 'transform 8s cubic-bezier(0.1, 0, 0, 1)';

                wheel.style.transform = `rotate(${currentRotation}deg)`;

                // 3. Finalize win after animation
                setTimeout(async () => {
                    if (nearMiss) {
                        tg.HapticFeedback.notificationOccurred('warning');
                    }

                    try {
                        const winRes = await fetch(`${NGROK_URL}/win-wheel`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                            body: JSON.stringify({ tgId: userId, winAmount: win })
                        });
                        const winData = await winRes.json();
                        
                        if (winRes.ok) {
                            // Synchronize with final server balance
                            updateUI(winData.newBalance);
                            tg.HapticFeedback.notificationOccurred(win >= 1 ? 'success' : 'warning');
                        }
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—ã–∏–≥—Ä—ã—à–∞");
                    }

                    btn.disabled = false;
                    backButton.show();
                    tg.disableClosingConfirmation();
                }, nearMiss ? 10100 : 8100);

            } catch (e) {
                tg.showAlert(e.message || "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏");
                btn.disabled = false;
                backButton.show();
                tg.disableClosingConfirmation();
            }
        }

        window.onload = () => updateUI();
    </script>
</body>
</html>