<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mines Pro - Financial Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #0f0f14);
            --sec-bg: var(--tg-theme-secondary-bg-color, #1b1f3a);
            --text: var(--tg-theme-text-color, #ffffff);
            --btn: var(--tg-theme-button-color, #5e8fff);
            --hint: var(--tg-theme-hint-color, #708499);
            --danger: #ff4d4d;
            --success: #2ecc71;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0; background-color: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding: 20px; box-sizing: border-box;
            user-select: none; -webkit-tap-highlight-color: transparent;
            touch-action: manipulation; position: relative;
        }

        .grid-wrapper {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 45px 45px;
            z-index: 0; pointer-events: none;
        }

        .balance-card {
            position: relative; z-index: 1;
            background: linear-gradient(145deg, var(--sec-bg), rgba(255,255,255,0.05));
            padding: 15px 45px; border-radius: 25px;
            font-size: 28px; font-weight: 900; margin-bottom: 20px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.4), inset 0 0 10px rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            font-variant-numeric: tabular-nums;
            display: flex; align-items: center; gap: 10px;
        }

        .info { 
            position: relative; z-index: 1; text-align: center; 
            margin-bottom: 15px; font-weight: 800; height: 30px; 
            font-size: 18px; text-transform: uppercase; letter-spacing: 1px; 
        }
        .current-x { color: var(--btn); font-size: 24px; text-shadow: 0 0 10px rgba(94, 143, 255, 0.5); }

        .grid {
            position: relative; z-index: 1;
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 12px; width: 100%; max-width: 340px; margin-bottom: 25px;
        }

        .cell {
            aspect-ratio: 1; background: var(--sec-bg); border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; cursor: pointer; transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .cell:active { transform: scale(0.9); }
        .cell.open { cursor: default; transform: none; background: rgba(255,255,255,0.03); }
        .cell.gem { background: rgba(46, 204, 113, 0.15); border-color: var(--success); text-shadow: 0 0 10px var(--success); }
        .cell.mine { border-color: var(--danger); background: rgba(255, 77, 77, 0.2); }

        .panel { position: relative; z-index: 1; width: 100%; max-width: 340px; display: flex; flex-direction: column; gap: 12px; }
        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .label { font-size: 11px; color: var(--hint); text-transform: uppercase; font-weight: 900; padding-left: 8px; letter-spacing: 0.5px; }
        
        input, select {
            background: var(--sec-bg); border: 2px solid var(--btn); color: white;
            padding: 16px; border-radius: 18px; font-size: 18px; outline: none;
            font-weight: bold; transition: 0.2s;
        }

        .btn {
            padding: 20px; border-radius: 20px; border: none;
            background: var(--btn); color: white; font-weight: 900;
            text-transform: uppercase; font-size: 17px; cursor: pointer;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2); transition: 0.1s;
        }
        .btn:active { transform: scale(0.97); }
        #cashoutBtn { background: var(--success); display: none; box-shadow: 0 6px 15px rgba(46, 204, 113, 0.3); }
    </style>
</head>
<body>
    <div class="grid-wrapper"></div>
    <div class="balance-card">
        <span id="bal-val">0.00</span> üí∞
    </div>
    <div class="info" id="status">–ù–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É</div>
    <div id="grid" class="grid"></div>
    <div class="panel">
        <div class="input-group">
            <span class="label">–†–∞–∑–º–µ—Ä —Å—Ç–∞–≤–∫–∏</span>
            <input type="number" id="betInp" value="1.00" min="0.1" step="0.1" inputmode="decimal">
        </div>
        <div class="input-group">
            <span class="label">–°–ª–æ–∂–Ω–æ—Å—Ç—å</span>
            <select id="mineSelect">
                <option value="3" selected>3 –ú–ò–ù–´</option>
                <option value="5">5 –ú–ò–ù</option>
                <option value="10">10 –ú–ò–ù</option>
            </select>
        </div>
        <button class="btn" id="startBtn" onclick="startGame()">–ò–≥—Ä–∞—Ç—å</button>
        <button class="btn" id="cashoutBtn" onclick="cashout()">–ó–∞–±—Ä–∞—Ç—å <span id="winAmount">0.00</span></button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const NGROK_URL = 'https://petrificant-phung-elliptically.ngrok-free.dev'; 
        const userId = tg.initDataUnsafe?.user?.id || 12345;
        let gameActive = false;
        let gemsFound = 0;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            if (!gameActive) {
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏ –¥–ª—è GitHub Pages
                window.location.href = './index.html'; 
            }
        });

        function createGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                cell.onclick = () => openCell(i);
                grid.appendChild(cell);
            }
        }

        async function updateUI() {
            try {
                const res = await fetch(`${NGROK_URL}/get-balance/${userId}`, {
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                });
                const data = await res.json();
                document.getElementById('bal-val').textContent = parseFloat(data.balance).toFixed(2);
            } catch (e) { console.error("Balance Error"); }
        }

        async function startGame() {
            const betVal = parseFloat(document.getElementById('betInp').value);
            const minesVal = parseInt(document.getElementById('mineSelect').value);
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;

            try {
                const res = await fetch(`${NGROK_URL}/play-mines`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ tgId: userId, bet: betVal, minesCount: minesVal })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                gameActive = true;
                gemsFound = 0;
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
                tg.BackButton.hide();

                document.getElementById('bal-val').textContent = data.newBalance.toFixed(2);
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('cashoutBtn').style.display = 'block';
                document.getElementById('status').innerHTML = '–ù–∞–π–¥–∏—Ç–µ üíé';
                document.getElementById('winAmount').textContent = '0.00';
                createGrid();
                tg.HapticFeedback.impactOccurred('medium');
            } catch (e) {
                tg.showAlert(e.message);
                startBtn.disabled = false;
            }
        }

        async function openCell(idx) {
            if (!gameActive) return;
            const cell = document.querySelector(`.cell[data-index="${idx}"]`);
            if (cell.classList.contains('open')) return;

            try {
                const res = await fetch(`${NGROK_URL}/reveal-cell`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ tgId: userId, cellIndex: idx })
                });
                const data = await res.json();

                if (data.type === 'mine') {
                    cell.innerHTML = 'üí£';
                    cell.classList.add('mine');
                    data.grid.forEach((val, i) => {
                        const c = document.querySelector(`.cell[data-index="${i}"]`);
                        if (val === 'mine') {
                            c.innerHTML = 'üí£';
                            c.classList.add('mine');
                        }
                    });
                    gameActive = false;
                    document.getElementById('status').innerHTML = '<span style="color:var(--danger)">–í–ó–†–´–í!</span>';
                    tg.HapticFeedback.notificationOccurred('error');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥ –ø–æ—Å–ª–µ –∏–≥—Ä—ã
                    tg.BackButton.show();
                    
                    setTimeout(resetGameUI, 2000);
                } else {
                    gemsFound = data.steps;
                    cell.innerHTML = 'üíé';
                    cell.classList.add('open', 'gem');
                    document.getElementById('status').innerHTML = `X: <span class="current-x">${data.multiplier}</span>`;
                    document.getElementById('winAmount').textContent = data.winSoFar.toFixed(2);
                    tg.HapticFeedback.impactOccurred('light');
                }
            } catch (e) { console.error(e); }
        }

        async function cashout() {
            if (!gameActive || gemsFound === 0) return;
            try {
                const res = await fetch(`${NGROK_URL}/win-mines`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ tgId: userId })
                });
                const data = await res.json();
                if (res.ok) {
                    tg.HapticFeedback.notificationOccurred('success');
                    document.getElementById('status').innerHTML = `<span style="color:var(--success)">+${data.winAmount.toFixed(2)} üí∞</span>`;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥ –ø–æ—Å–ª–µ –≤—ã–∏–≥—Ä—ã—à–∞
                    tg.BackButton.show();
                    
                    await updateUI();
                    setTimeout(resetGameUI, 2000);
                }
            } catch (e) { console.error(e); }
        }

        function resetGameUI() {
            gameActive = false;
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('cashoutBtn').style.display = 'none';
            document.getElementById('status').innerText = "–ù–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É";
            createGrid();
        }

        window.onload = () => {
            createGrid();
            updateUI();
            tg.expand();
            tg.ready();
        };
    </script>
</body>
</html>